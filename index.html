<!DOCTYPE html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="generator" content="Hugo 0.84.0" />
    <title>PDF Comparator</title>

    <link
      rel="canonical"
      href="https://getbootstrap.com/docs/5.0/examples/sticky-footer/"
    />
    <script src="https://cdn.jsdelivr.net/npm/hash-string@1.0.0/build/hash-string.min.js"></script>
    <!-- Bootstrap core CSS -->
    <!-- <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet" /> -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      table {
        background-color: white;
      }

      /* .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    } */
    </style>

    <!-- Custom styles for this template -->
    <link href="sticky-footer.css" rel="stylesheet" />
  </head>

  <body>
    <div class="container-fluid" style="position: absolute; top: 0; left: 5px">
      <div class="mt-1">
        <div class="row">
          <div class="col-lg-12">
            <div class="offset-5 col-lg-6">
              <p class="h2" style="color: #650360; margin-bottom: 2em">
                PDF Comparator
              </p>
            </div>
          </div>
        </div>
      </div>
      <div id="settings" class="mt-1">
        <!-- <label
          ><input type="radio" name="diff_type" value="diffWords" checked />
          Words</label
        > -->
        <label
          ><input type="radio" name="diff_type" value="diffLines" checked />
          Lines</label
        >
        <!-- <label
          ><input type="radio" name="diff_type" value="diffPatch" /> Just
          Highlight Changes</label
        > -->
      </div>
      <div class="row">
        <div class="offset-2 col-lg-10">
          <button
            type="button"
            class="btn btn-primary"
            id="compare_button"
            style="
              width: 40;
              background-color: #650360;
              border-color: #650360;
              font-weight: bold;
            "
          >
            Compare Content
          </button>
        </div>
        <div class="col-lg-2">
          <div class="col-lg-12">
            <h6 style="font-weight: bold" class="mt-3">Previous Version</h6>
          </div>
          <div
            contenteditable="true"
            id="a"
            style="height: 100%; background-color: white"
          ></div>
        </div>
        <div class="col-lg-2">
          <div class="col-lg-12">
            <h6 style="font-weight: bold" class="mt-3">Recent Version</h6>
          </div>
          <div
            contenteditable="true"
            id="b"
            style="height: 100%; background-color: white"
          ></div>
        </div>
        <div class="col-lg-3">
          <h6 style="font-weight: bold" class="mt-3">Summary of changes</h6>
          <div class="col-lg-12">
            <div class="row">
              <div class="col-lg-12">
                <h6
                  style="
                    font-weight: bold;
                    font-size: smaller;
                    color: rgb(90, 89, 89);
                  "
                >
                  Recent Version:
                </h6>
              </div>
              <div class="col-lg-12">
                <div class="row">
                  <div class="col-lg-6">
                    <h6
                      id="adds"
                      style="
                        color: #406619;
                        background: #eaf2c2;
                        width: fit-content;
                      "
                    ></h6>
                  </div>
                </div>
              </div>
              <table class="table" id="uniquetable">
                <thead>
                  <tr>
                    <th scope="col" style="width: 80%">Text</th>
                    <th scope="col">Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="col-lg-12">
                <h6
                  style="
                    font-weight: bold;
                    font-size: smaller;
                    color: rgb(90, 89, 89);
                  "
                  class="mt-3"
                >
                  Recurring Text
                </h6>
              </div>
              <div class="col-lg-6">
                <h6
                  id="duplicateadds"
                  style="
                    color: #406619;
                    background: #eaf2c2;
                    width: fit-content;
                  "
                ></h6>
              </div>
              <table class="table" id="duplicatetable">
                <thead>
                  <tr>
                    <th scope="col" style="width: 80%">Text</th>
                    <th scope="col">Count</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="col-lg-12">
                <div class="row">
                  <div class="col-lg-6">
                    <h6
                      id="deletes"
                      style="
                        color: #b30000;
                        background: #fadad7;
                        width: fit-content;
                      "
                    ></h6>
                  </div>
                </div>
              </div>
              <table class="table" id="uniquedeletetable">
                <thead>
                  <tr>
                    <th scope="col" style="width: 80%">Text</th>
                    <th scope="col">Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-lg-5 mt-3">
          <div
            id="result"
            style="height: 100%; width: 100%; background-color: white"
          >
            Previous Version
          </div>
        </div>
      </div>
    </div>

    <script src="diff.js"></script>
    <script src="difflib-browser.js"></script>
    <script defer>
      var del_string_test = "";
      var add_string_test = "";

      var changes_textdelete_hash = new Set();
      var changes_textadd_hash = new Set();

      //Map to store content
      var changes_map = new Map();
      // Map to store hash ID counts
      const change_map_counts = new Map();
      var a = document.getElementById("a");
      var b = document.getElementById("b");
      var result = document.getElementById("result");

      function reset_elements() {
        const uniquetable = document.getElementById("uniquetable");
        const duplicatetable = document.getElementById("duplicatetable");
        const uniquedeletetable = document.getElementById("uniquedeletetable");
        const deletes = document.getElementById("deletes");
        const duplicateadds = document.getElementById("duplicateadds");
        const adds = document.getElementById("adds");
        uniquetable.innerHTML = "";
        duplicatetable.innerHTML = "";
        uniquedeletetable.innerHTML = "";
        deletes.innerHTML = "";
        duplicateadds.innerHTML = "";
        adds.innerHTML = "";
        changes_textadd_hash.clear();
        changes_textdelete_hash.clear();
        changes_map.clear();
        change_map_counts.clear();
      }
      function findDifferentChar(str1, str2) {
        s = new difflib.SequenceMatcher(null, str1, str2);
        return s;
      }
      function updateMapcount(map, hashid) {
        if (map.has(hashid)) {
          // Increment count if hashId already exists in the map
          map.set(hashid, map.get(hashid) + 1);
        } else {
          // Initialize count to 1 if hashId is not in the map
          map.set(hashid, 1);
        }
      }

      // Your JavaScript function to be called
      function handleLinkClick(key) {
        // Prevent default link behavior (going to a new page)
        event.preventDefault();
        console.log("Clicked key:", key);
        const targetElement = document.getElementById(key);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: "smooth" });
        } else {
          console.log("Element with ID not found:", key);
        }
      }

      function write_to_uniqchange_table(hashidset, pdfcountmap, id) {
        const tableBody = document.getElementById(id); // Select the table body

        hashidset.forEach((id) => {
          console.log(id);
          var key = id;
          var value = pdfcountmap.get(id);
          const row = `
      <tr>
        <td>${value}</td>
        <td><a href="#" onclick="handleLinkClick('${key}')">${"link"}</a></td> 
      </tr>
    `;
          tableBody.innerHTML += row; // Append the row to the table body
        });
      }

      function write_to_table(pdfcountmap, id) {
        const tableBody = document.getElementById(id); // Select the table body
        const sortedPdfCountMap = new Map(
          [...pdfcountmap.entries()].sort((a, b) => a[1] - b[1])
        );

        for (const [key, value] of sortedPdfCountMap.entries()) {
          var repeated_text = changes_map.get(key);
          var repeated_text_count = value;
          if (repeated_text_count >= 1) {
            const row = `
      <tr>
        <td>${repeated_text}</td>
        <td>${value}</td>
      </tr>
    `;
            tableBody.innerHTML += row; // Append the row to the table body
          }
        }
      }

      function sumMapValues(pdftotalcountmap) {
        let totalCount = 0;
        for (const value of pdftotalcountmap.values()) {
          totalCount += value;
        }
        return totalCount;
      }

      function printidmapandContent(pdfcountmap) {
        for (const [key, value] of pdfcountmap.entries()) {
          console.log(`Key: ${key}, Value: ${value}`);
        }
        const totalCount = sumMapValues(pdfcountmap);
        return totalCount;
      }

      function printSet(pdfcomparedataset, map) {
        // Using forEach method
        pdfcomparedataset.forEach((value) => {
          console.log("Hash Id:\t" + value + " Value:\t" + map.get(value));
        });
      }

      function normalizeText(text) {
        text = text.toLowerCase();
        text = text.replace(/\s+/g, " "); // Remove extra whitespace
        text = text.replace(/[\t~!\':.,;`\[\]\n"“” ]+/g, "");
        return text;
      }

      function compareStrings(str1, str2) {
        return normalizeText(str1) === normalizeText(str2);
      }

      function changed() {
        reset_elements();
        var fragment = document.createDocumentFragment();
        var diff;
        if (window.diffType === "diffPatch") {
          // We contort the patch into a similar data structure to that returned by diffChars,
          // diffWords, etc so that the same rendering code below can work on both.
          var pastChunkHeader = false;
          diff = Diff.createTwoFilesPatch(
            "a.txt",
            "b.txt",
            a.textContent,
            b.textContent
          )
            .split("\n")
            .map(function (entry) {
              const result = {
                value: entry + "\n",
              };
              if (entry.startsWith("@@")) {
                result.chunkHeader = true;
                pastChunkHeader = true;
              } else if (pastChunkHeader) {
                if (entry.startsWith("-")) {
                  result.removed = true;
                } else if (entry.startsWith("+")) {
                  result.added = true;
                }
              }
              return result;
            });
        } else {
          let options = {};
          options.ignoreWhitespace = true;
          options.newlineIsToken = true;
          diff = Diff[window.diffType](a.textContent, b.textContent);
        }

        for (var i = 0; i < diff.length; i++) {
          if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
            var swap = diff[i];
            diff[i] = diff[i + 1];
            diff[i + 1] = swap;
          }
          var node;

          if (diff[i].removed) {
            node = document.createElement("del");
            var text_value = diff[i].value;
            var normalize_text_value = normalizeText(text_value);
            let normalize_text_value_formatted = normalize_text_value.trim();
            del_string_test = normalize_text_value_formatted;
            console.log("DEL VAL:" + normalize_text_value_formatted);
            if (normalize_text_value_formatted != "") {
              var hashid = hash(normalize_text_value_formatted);
              changes_map.set(hashid, text_value);

              if (!changes_textdelete_hash.has(hashid)) {
                changes_textdelete_hash.add(hashid);
              } else {
                updateMapcount(change_map_counts, hashid);
              }
              node.id = hashid;
              node.appendChild(document.createTextNode(text_value));
            }
          } else if (diff[i].added) {
            node = document.createElement("ins");
            var text_value = diff[i].value;
            var normalize_text_value = normalizeText(text_value);
            let normalize_text_value_formatted = normalize_text_value.trim();
            add_string_test = normalize_text_value_formatted;
            console.log("N VAL:" + normalize_text_value_formatted);
            if (normalize_text_value_formatted != "") {
              var hashid = hash(normalize_text_value_formatted);
              console.log("ADD Hash ID\t" + hashid);
              if (changes_textdelete_hash.has(hashid)) {
                console.log(
                  "-------SAME PRESENT in ADD and DELETE-----\t" + hashid
                );
                console.log(changes_map.get(hashid));
                console.log(
                  "----------------------------------------------------"
                );
              } else {
                changes_map.set(hashid, text_value);
              }
              if (
                !changes_textadd_hash.has(hashid) &&
                !changes_textdelete_hash.has(hashid)
              ) {
                changes_textadd_hash.add(hashid);
              } else if (changes_textadd_hash.has(hashid)) {
                updateMapcount(change_map_counts, hashid);
              }
              node.id = hashid;
              node.appendChild(document.createTextNode(text_value));
            }
          } else if (diff[i].chunkHeader) {
            node = document.createElement("span");
            node.setAttribute("class", "chunk-header");
            node.appendChild(document.createTextNode(diff[i].value));
          } else {
            node = document.createTextNode(diff[i].value);
          }
          fragment.appendChild(node);
        }

        result.textContent = "";
        result.appendChild(fragment);
        var add_summary = document.getElementById("adds");
        var delete_summary = document.getElementById("deletes");
        var duplicate_add_summary = document.getElementById("duplicateadds");

        var duplicate_text_count = printidmapandContent(change_map_counts);
        add_summary.innerHTML = "Unique Adds:\t" + changes_textadd_hash.size;
        duplicate_add_summary.innerHTML = "Duplicate:\t" + duplicate_text_count;
        delete_summary.innerHTML =
          "Unique Deletes:\t" + changes_textdelete_hash.size;

        var duplicate_text_delete_count =
          printidmapandContent(change_map_counts);

        write_to_table(change_map_counts, "duplicatetable");
        write_to_uniqchange_table(
          changes_textadd_hash,
          changes_map,
          "uniquetable"
        );
        write_to_uniqchange_table(
          changes_textdelete_hash,
          changes_map,
          "uniquedeletetable"
        );
        var match_ratio = findDifferentChar(del_string_test, add_string_test);
        console.log("Interesting:" + match_ratio.ratio());
      }

      window.onload = function () {
        var a = document.getElementById("a");
        var b = document.getElementById("b");
        a.innerHTML = "";
        b.innerHTML = "";
        onDiffTypeChange(
          document.querySelector('#settings [name="diff_type"]:checked')
        );
        changed();
        disable_compare_button();
        var button = document.getElementById("compare_button");
        button.onclick = changed;
      };

      function disable_compare_button() {
        var button = document.getElementById("compare_button");
        button.disabled = true;
      }

      function enable_compare_button() {
        var button = document.getElementById("compare_button");
        button.disabled = false;
      }

      b.onpaste = b.onchange = enable_compare_button;

      // a.onpaste = a.onchange = b.onpaste = b.onchange = changed;

      // if ("oninput" in a) {
      //   a.oninput = b.oninput = changed;
      // } else {
      //   a.onkeyup = b.onkeyup = changed;
      // }

      function onDiffTypeChange(radio) {
        window.diffType = radio.value;
        document.title = "Diff " + radio.value.slice(4);
      }

      var radio = document.getElementsByName("diff_type");
      for (var i = 0; i < radio.length; i++) {
        radio[i].onchange = function (e) {
          onDiffTypeChange(e.target);
          changed();
        };
      }
    </script>
  </body>
</html>
